<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>UTb - Subscription based YouTube playlist generator</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.6/moment.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.js"></script>
  <script src="./keys.js"></script>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap-theme.min.css">
  <link rel="stylesheet" type="text/css" href="utb.css">
</head>
<body>

<nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <a class="navbar-brand" href="/">UTb</a>
    </div>
  </div>
</nav> 

<div class="jumbotron">
  <div class="container">
    <h1>UTb</h1>
    <p>This is a youtube playlist generator based on your subscription.</p>
  </div>
</div>

<div class="container">
  <div class="center_container">
    <button type="button" id="btnAuth" class="btn btn-success btn-large btn-block" disabled="disabled">Authorize & Get new video list</button>
  </div>
  <div class="center_container">
    <div style="margin: auto; width:100%; text-align: center;" class="glyphicon glyphicon-menu-down"></div>
  </div>
  <div class="center_container">
    <h5 id="step1">Retrieving new video information</h5>
  </div>
  <div class="center_container">
    <div style="margin: auto; width:100%; text-align: center;" class="glyphicon glyphicon-menu-down"></div>
  </div>
  <div class="center_container">
    <div id="result"></div>
    <div id="videoList"></div>
  </div>
  <!--
  <div class="center_container">
    <h5>Playlist options here</h5>
  </div>
  -->
  <div class="center_container">
    <button type="button" id="btnMakeList" class="btn btn-success btn-large btn-block">Make a playlist and upload to YouTube</a>
  </div>
  <div class="center_container">
    <div style="margin: auto; width:100%; text-align: center;" class="glyphicon glyphicon-menu-down"></div>
  </div>
  <div class="center_container">
    <h5 id="step2">Making a playlist</h5>
  </div>
  <div class="center_container">
    <div style="margin: auto; width:100%; text-align: center;" class="glyphicon glyphicon-menu-down"></div>
  </div>
  <div class="center_container">
    <h5 id="step3">Uploading a playlist to YouTube</h5>
  </div>
  <div class="center_container">
    <div style="margin: auto; width:100%; text-align: center;" class="glyphicon glyphicon-menu-down"></div>
  </div>
  <div class="center_container">
    <h5 id="step4">Done</h5>
  </div>
</div>
<div style="height: 30px;"></div>

<script>
(function (global) {
  // TODO 시청한 비디오를 목록 만들 때 제거하는 기능
  
  var IN_PROGRESS = 'blink';

  var MAX_RESULTS_PER_REQUEST = 50;
  var ACTIVITY_TYPE = {
        BULLETIN: 'bulletin',
        CHANNEL_ITEM: 'channelItem',
        COMMENT: 'comment',
        FAVORITE: 'favorite',
        LIKE: 'like',
        PLAYLIST_ITEM: 'playlistItem',
        RECOMMENDATION: 'recommendation',
        SOCIAL: 'social',
        SUBSCRIPTION: 'subscription',
        UPLOAD: 'upload'
  };


  var CONSTRAINTS = {
    MAX_VIDEO_PLAYTIME: 10 * 60, // min
    INCLUDE_RECOMMENDATION: false,
    checkMaxLength: function (videoInfo) {
      if (videoInfo.utbData.duration <= CONSTRAINTS.MAX_VIDEO_PLAYTIME) {
        return true;
      }
    },
    CHANNEL_EXCLUDED: [
      'UCvc8kv-i5fvFTJBFAk6n1SA', // 생활코딩
      'UClMlpXq4tDryAioZisO7JJQ', // 굿샷김프로
      'UCsLdjJ-pztJ7xV1axh14p5Q', // Yonsei HCI Lab,
      'UCEBb1b_L6zDS3xTUrIALZOw', // MIT OpenCourseWare
    ],
    checkExcludedChannel: function (videoInfo) {
      var index = _.indexOf(CONSTRAINTS.CHANNEL_EXCLUDED, videoInfo.snippet.channelId);

      if (index < 0) {
        return true;
      }
    },
    AFTER_DAYS: 2,
    checkAfterDays: function (videoInfo) {
      var baseDate = moment().subtract(CONSTRAINTS.AFTER_DAYS, 'days');
      var pubDate = moment(videoInfo.snippet.publishedAt);
      return baseDate.isBefore(pubDate);
    }
  };

  var utb = {
    apiKey: keys.apiKey,
    clientId: keys.clientId,
    scopes: keys.scopes,

    activities: [],
    video_activities: {},

    activitiy_loaded: 0,
    video_loaded: 0,

    playList: [],

    totalPlayTime: 0,

    apiLoaded: function () {
      // console.log('utb#apiLoaded');

      gapi.client.setApiKey(this.apiKey);
      setTimeout(_.bind(this.checkAuth, this), 1);
    },

    checkAuth: function (immediate) {
      // console.log('utb#checkAuth');

      if (immediate === undefined) {
        immediate = true
      }

      gapi.auth.authorize({
        client_id: this.clientId,
        scope: this.scopes,
        immediate: immediate
      }, _.bind(this.handleAuthResult, this));
    },

    handleAuthResult: function (authResult) {
      // console.log('utb#handleAuthResult');

      var $authorizeButton = $('#btnAuth');

      if (authResult && !authResult.error) {
        $authorizeButton.prop('disabled', true);
        // console.info('utb#Authorized');
        this.makePlaylist();
      } else {
        $authorizeButton.prop('disabled', false);
        $authorizeButton.on('click', _.bind(this.handleAuthClick, this));
      }
    },

    handleAuthClick: function () {
      // console.log('utb#handleAuthResult');

      this.checkAuth(false);
      return false;
    },

    makePlaylist: function () {
      // console.info('utb#fetch activities');

      var self = this;

      $('#step1').addClass(IN_PROGRESS);

      this.getActivities()
          .then(function () {
            // console.info('utb#fetch video info');
            return Promise.resolve();
          })
          .then(_.bind(this.getVideoInfo, this))
          .then(function () {
            // console.info('utb#make today\'s playlist');
            return Promise.resolve();
          })
          .then(_.bind(this.makePlayList, this))
          .then(_.bind(this.makeResult, this))
          .then(function () {
            // console.info('utb#done');
            $('#step1').removeClass(IN_PROGRESS);
          });

    },

    getActivities: function (path, params) {
      var self = this;
      var newPath = path || '/activities';
      var newParams = params || {
        part: 'snippet,contentDetails',
        home: true
      };

      return this._request(newPath, newParams).then(function (res) {
        self.activitiy_loaded += res.result.items.length;
        self.activities = self.activities.concat(self._getVideoActivities(res.result.items));

        // pageInfo.totalResults가 제일 마지막 페이지에 이르기 전까지
        // 1이 더 많게 나오는 경우가 있음. 그러나 마지막에는 정상적으로 노출되어 정상 동작함.
        // 왜일까?
        if (self.activitiy_loaded < res.result.pageInfo.totalResults) {
          return self.getActivities(newPath, _.defaults({
            pageToken: res.result.nextPageToken
          }, newParams));
        }
      }, function (reason) {
        console.log('Error: ' + reason.result.error.message);
      });
    },

    _getVideoActivities: function (items) {
      var self = this;

      return _.filter(items, function (item) {
        var result = false;
        var videoId;

        switch (item.snippet.type) {
        case ACTIVITY_TYPE.RECOMMENDATION:
          if (CONSTRAINTS.INCLUDE_RECOMMENDATION) {
            videoId = item.contentDetails.recommendation.resourceId.videoId;
            self.video_activities[videoId] = item;
            result = true;
          }
          break;
        case ACTIVITY_TYPE.UPLOAD:
          videoId = item.contentDetails.upload.videoId;
          self.video_activities[videoId] = item;
          result = true;
          break;
        }
        
        return result;
      });
    },

    getVideoInfo: function () {
      var self = this;
      var newPath = '/videos';
      var newParams = {
        part: 'contentDetails'
      };

      var targetVideos = this.activities.slice(this.video_loaded, this.video_loaded + MAX_RESULTS_PER_REQUEST);

      var ids = _.map(targetVideos, function (videoInfo) {
        switch (videoInfo.snippet.type) {
        case ACTIVITY_TYPE.UPLOAD:
          return videoInfo.contentDetails.upload.videoId;
          break;
        case ACTIVITY_TYPE.RECOMMENDATION:
          return videoInfo.contentDetails.recommendation.resourceId.videoId;
          break;  
        }
      });

      this.video_loaded += MAX_RESULTS_PER_REQUEST;
      
      newParams.id = ids.join(',');

      return this._request(newPath, newParams).then(function (res) {
        self._addVideoProperties(res.result.items);

        if (self.video_loaded < self.activities.length) {
          return self.getVideoInfo()
        }
      }, function (reason) {
        console.log('Error: ' + reason.result.error.message);
      });
    },

    _addVideoProperties: function (videoInfo) {
      var self = this;
      _.each(videoInfo, function (info) {
        var video = self.video_activities[info.id];
        video.utbData = {
          duration: self._getDurationInSec(info.contentDetails.duration),
          videoId: info.id
        }
      });
    },

    _getDurationInSec: function (duration) {
      var regexp = /PT((\d+)H)?((\d+)M)?((\d+)S)?/;
      var result = regexp.exec(duration);
      var time = 0;

      if (result[2]) {
        time += parseInt(result[2], 10) * 3600;
      }

      if (result[4]) {
        time += parseInt(result[4], 10) * 60;
      }

      if (result[6]) {
        time += parseInt(result[6], 10);
      }

      return time;
    },

    makePlayList: function () {
      var self = this;
      var result = self.video_activities;

      _.each(CONSTRAINTS, function (constraint) {
        if (!_.isFunction(constraint)) {
          return;
        }

        result = _.filter(result, constraint);
      });

      result = _.sortBy(result, function (item) {
        return -1 * moment(item.snippet.publishedAt).format('X');
      });

      this.playList = result;

      return Promise.resolve();
    },

    makeResult: function () {
      var self = this;
      var videoCount = _.size(this.playList);

      var template = Handlebars.compile($('#resultTemplate').html());
      var htmlResult = '';
    
      _.each(this.playList, function (item) {
        self.totalPlayTime += item.utbData.duration;
      });

      htmlResult = template({
        videoCount: videoCount,
        playTime: this.totalPlayTime,
        avgPlayTime: Math.round(100 * this.totalPlayTime/videoCount) / 100,
        items: this.playList
      });

      $('#result').html(htmlResult);
      $('.carousel-inner').find('.item').first().addClass('active');
      $('.carousel').carousel({
        interval: 2000
      });
      $('#btnMakeList').on('click', function (e) {
        e.preventDefault();

        self.uploadPlayList();
      });
    },

    uploadPlayList: function () {
      // console.info('utb#make today\'s playlist');

      $('#step2').addClass(IN_PROGRESS);

      this.makeYouTubePlayList().then(function () {
        // console.info('utb#make today\'s playlist items');
        $('#step2').removeClass(IN_PROGRESS);
        $('#step3').addClass(IN_PROGRESS);
        return Promise.resolve(arguments);
      })
      .then(_.bind(this.makePlayListItems, this))
      .then(function () {
        $('#step3').removeClass(IN_PROGRESS);
        $('#step4').addClass(IN_PROGRESS);
        // console.log('utb#done');
      })
    },

    makeYouTubePlayList: function () {
      var self = this;
      var path = '/playlists';
      var params = {
        part: 'snippet,status',
        resource: {
          snippet: {
            title: this.getTitle(),
            description: this.getDescription()
          },
          status: {
            privacyStatus: 'private'
          }
        }
      };

      return gapi.client.youtube.playlists.insert(params);
    },

    getTitle: function () {
      return moment().format('M월 D일의 플레이리스트');
    },

    getDescription: function () {
      return this.getTitle() + '를 즐기세요.';
    },

    makePlayListItems: function (res) {
      var promise = Promise.resolve();

      var listInfo = res[0].result;
      var params = {
        part: 'snippet',
        snippet: {
          playlistId: listInfo.id
        }
      };

      _.each(this.playList, function (item) {
        // Promise.all을 사용하여 동시에 여러 요청을 보낼 경우 
        // api 이슈인지 마지막 값으로 캐시되는 문제가 있어 순차적으로 요청을 보낸다.
        promise = promise.then(function () {
          var newParams = params;
          newParams.snippet.resourceId = {
            videoId: item.utbData.videoId,
            kind: 'youtube#video'
          };

          return gapi.client.youtube.playlistItems.insert(newParams);
        });
      });

      return promise;
    },

    _request: function (path, params) {
      var self = this;

      params = _.extend({
        maxResults: MAX_RESULTS_PER_REQUEST
      }, params);

      return gapi.client.request({
        'path': '/youtube/v3' + path,
        'params': params
      });
    }
  };

  global.utb = utb;
})(window);

function initialize() {
  // console.info('utb#start');
  gapi.client.load('youtube', 'v3', start)
}

function start() {
  utb.apiLoaded();
}

</script>

<script id="resultTemplate" type="text/x-handlebars-template">
<div>
  <div class="row">
    <div class="col-sm-4">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Video(s)</h3>
        </div>
        <div class="panel-body">
          {{videoCount}}
        </div>
      </div>
    </div>
    <div class="col-sm-4">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Total Play Time</h3>
        </div>
        <div class="panel-body">
          {{playTime}}sec
        </div>
      </div>
    </div>
    <div class="col-sm-4">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Video Avg. Play Time</h3>
        </div>
        <div class="panel-body">
          {{avgPlayTime}}sec
        </div>
      </div>
    </div>
  </div>
  <div id="carousel-example-generic" class="carousel slide" data-ride="carousel" style="margin-bottom: 20px;">
    <div class="carousel-inner" role="listbox">
      {{#each items}}
      <div class="item">
        <img src="{{snippet.thumbnails.standard.url}}" alt="{{snippet.title}}">
        <div class="carousel-caption">
          <a href="https://www.youtube.com/watch?v={{utbData.videoId}}" style="color:#fff;text-shadow: 0px 0px 5px #000000;font-size: 22px;"><span>{{snippet.title}}</span></a>
        </div>
      </div>
      {{/each}}
    </div>
    <a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">
      <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
      <span class="sr-only">Previous</span>
    </a>
    <a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">
      <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
      <span class="sr-only">Next</span>
    </a>
  </div>
</div>
</script>

<script id="videoListTemplate" type="text/x-handlebars-template">
    {{#each items}}
    <li><a href="https://www.youtube.com/watch?v={{utbData.videoId}}"><span>[{{snippet.publishedAt}}]{{snippet.title}} ({{utbData.duration}} sec)</span><br><img src="{{snippet.thumbnails.medium.url}}" width="{{snippet.thumbnails.medium.width}}" height="{{snippet.thumbnails.medium.heihgt}}"></a></li>
    {{/each}}
</script>

<script id="videoListTemplate" type="text/x-handlebars-template">
<div>
  
</div>
</script>
<script src="https://apis.google.com/js/client.js?onload=initialize"></script>
</body>
</html>